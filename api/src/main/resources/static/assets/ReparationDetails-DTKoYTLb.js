import{u as A,j as e,y as j,r as g}from"./index-yGwYt6Nq.js";import{f as G,h as T}from"./hooks-DhN4L3JL.js";import{B as O}from"./badge-Bi_LB_J8.js";import{a as B,b as k,g as z}from"./utils-B63l6kq4.js";import{M as w}from"./Modal-p6Bw6WIw.js";import{u as P,s as M,z as v,C as V}from"./index-DPb_3Eze.js";import{I as C}from"./Input-BljE3152.js";import{B as S}from"./Button-nvBNfKxG.js";import{R as U,a as E,L as I}from"./label-wM3WakGA.js";import{u as $}from"./useReparationReportPdf-B5usvG3v.js";import{T as _}from"./Table-jwmTVb_L.js";import{u as R}from"./useMutation-B29Hiwaj.js";import{r as D}from"./request-DFzFQ-HD.js";import"./useQuery-wnBeM4WK.js";import"./index-Y2e7ilkQ.js";import"./index-D4j-s7ve.js";import"./index-BDwWvORE.js";import"./x-D4ZDirHF.js";import"./index-CIc1txwD.js";function q(){const{id:s}=A();return{numericId:s?parseInt(s,10):-1}}const F=v.object({customerComplaint:v.string().nonempty("La description ne peut pas être vide."),repairStatus:v.enum(["ALL","IN_PROGRESS","COMPLETED"])}),W=({toggleForm:s,initialReparation:t,onUpdateSuccess:r})=>{const{mutate:m,isPending:c}=G(),{register:h,handleSubmit:o,reset:p,control:u,formState:{errors:i}}=P({defaultValues:{customerComplaint:t.customerComplaint,repairStatus:t.repairStatus},resolver:M(F)}),n=d=>{const y={...t,customerComplaint:d.customerComplaint,repairStatus:d.repairStatus};m(y,{onSuccess:f=>{p(),s==null||s(!1),j.success(f.message),r==null||r()}})};return e.jsxs("form",{className:"space-y-6",onSubmit:o(n),children:[e.jsxs("div",{children:[e.jsx(C,{label:"Description du problème *",...h("customerComplaint")}),i.customerComplaint&&e.jsx("p",{className:"text-red-500",children:i.customerComplaint.message})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 font-medium",children:"Statut de réparation *"}),e.jsx(V,{name:"repairStatus",control:u,render:({field:d})=>e.jsxs(U,{...d,value:d.value,onValueChange:d.onChange,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(E,{value:"IN_PROGRESS",id:"in-progress"}),e.jsx(I,{htmlFor:"in-progress",children:"En cours"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(E,{value:"COMPLETED",id:"completed"}),e.jsx(I,{htmlFor:"completed",children:"Terminée"})]})]})}),i.repairStatus&&e.jsx("p",{className:"text-red-500",children:i.repairStatus.message})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(S,{type:"submit",disabled:c,children:c?"En cours...":"Modifier"})})]})},H=({reparation:s})=>{var i;const[t,r]=g.useState(!1),{isLoading:m,error:c,setSelectedReparation:h}=$(),o=n=>n?new Date(n).toLocaleDateString("fr-FR"):"Non définie",p=()=>{r(!1)},u=n=>{h(n)};return s?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 pb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["Réparation #",s.callNumber]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Informations générales"})]}),e.jsx(S,{onClick:()=>r(!0),children:"Modifier"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded-md p-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Problème signalé"}),e.jsx("p",{className:"text-gray-700",children:s.customerComplaint})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Date d'entrée"}),e.jsx("span",{className:"text-sm text-gray-900",children:o(s.entryDate)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Date de sortie"}),e.jsx("span",{className:"text-sm text-gray-900",children:s.releaseDate?o(s.releaseDate):"Non terminé"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Statut"}),e.jsx(O,{className:k(s.repairStatus),children:B(s.repairStatus)})]}),e.jsx(S,{onClick:()=>u(s),disabled:m,children:m?"Génération...":"Voir fiche de réparation"}),c&&e.jsxs("p",{className:"text-red-500 text-sm mt-2",children:["Erreur : ",c.message]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 rounded-md p-4",children:[e.jsx("h3",{className:"font-medium text-blue-900 mb-3",children:"Machine"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Désignation"}),e.jsx("span",{className:"text-sm text-blue-900",children:s.machine.designation})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Référence"}),e.jsx("span",{className:"text-sm text-blue-900",children:s.machine.reference})]})]})]}),e.jsxs("div",{className:"bg-green-50 rounded-md p-4",children:[e.jsx("h3",{className:"font-medium text-green-900 mb-3",children:"Client"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-green-700",children:"Nom"}),e.jsx("span",{className:"text-sm text-green-900",children:z(s.machine.partner)})]}),((i=s.machine.partner.phoneNumbers)==null?void 0:i.length)>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-green-700 block mb-1",children:"Téléphones"}),e.jsx("div",{className:"space-y-1",children:s.machine.partner.phoneNumbers.map((n,d)=>e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:"text-sm text-green-900 bg-white px-2 py-1 rounded border",children:n.number})},d))})]})]})]})]})]}),e.jsx(w,{title:"Mettre à jour la réparation",isOpen:t,onClose:()=>r(!1),size:"md",children:e.jsx(W,{onUpdateSuccess:p,initialReparation:s})})]}):e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500",children:"Chargement des informations..."})]})})})},J=(s,t)=>D({url:`/details/${t}`,method:"post",data:s}),K=s=>D({url:"/details",method:"put",data:s}),Q=s=>D({url:`/details/${s}`,method:"delete"}),X=()=>R({mutationFn:({detail:s,id:t})=>J(s,t).then(r=>{if(r.status==="error")throw new Error(r.message);return r})}),Y=()=>R({mutationFn:s=>K(s).then(t=>{if(t.status==="error")throw new Error(t.message);return t})}),Z=()=>R({mutationFn:s=>Q(s)}),ee=v.object({description:v.string().min(1,"Veuillez ajouter une description de maintenance effectuée"),price:v.number().min(.01,"Ajouter un prix valide")}),L=({toggleForm:s,initialReparationDetail:t,onUpdateSuccess:r,onAddSuccess:m,reparationId:c})=>{const{mutate:h,isPending:o}=X(),{mutate:p,isPending:u}=Y(),i=!!t,n=i?u:o,{register:d,handleSubmit:y,reset:f,formState:{errors:b}}=P({defaultValues:{description:(t==null?void 0:t.description)||"",price:(t==null?void 0:t.price)||0},resolver:M(ee)}),l=a=>{if(i&&t){const x={...t,description:a.description,price:a.price};p(x,{onSuccess:()=>{f(),s==null||s(!1),r==null||r(x),j.success("Réparation modifiée avec succès")},onError:N=>{j.error("Erreur lors de la modification"),console.error(N)}})}else if(c){const x={detail:{description:a.description,price:a.price},id:c};h(x,{onSuccess:N=>{f(),j.success(N.message),s==null||s(!1),m==null||m(N.data)},onError:N=>{j.error(N.message)}})}};return e.jsxs("form",{className:"space-y-6",onSubmit:y(l),children:[e.jsxs("div",{children:[e.jsx(C,{label:"Description *",...d("description")}),b.description&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:b.description.message})]}),e.jsxs("div",{children:[e.jsx(C,{label:"Prix *",type:"number",step:"0.01",min:"0",...d("price",{valueAsNumber:!0})}),b.price&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:b.price.message})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(S,{type:"submit",disabled:n,children:n?"En cours...":i?"Modifier":"Ajouter"})})]})},se=({reparation:s})=>{const[t,r]=g.useState(!1),[m,c]=g.useState(),[h,o]=g.useState(!1),[p,u]=g.useState((s==null?void 0:s.detailsList)||[]),{mutate:i}=Z();g.useEffect(()=>{s&&u(s==null?void 0:s.detailsList)},[s]),console.log("1 : "+(s==null?void 0:s.detailsList)),console.log("2 : "+p);const n=["Description","Prix"],d=l=>{c(l),r(!0)},y=l=>{u(a=>a.filter(x=>x.id!==l)),i(l,{onSuccess:a=>{j.success(a.message)},onError:a=>{j.error(a.message)}})},f=l=>{u(a=>a.map(x=>x.id===l.id?l:x)),r(!1),c(void 0)},b=l=>{u(a=>[...a,l]),o(!1),c(void 0)};return s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-2xl font-semibold text-gray-800",children:"Détails de la réparation"}),e.jsx(S,{onClick:()=>o(!0),children:"Ajouter"})]}),e.jsx(_,{head:n,data:p,variant:"WithActions",onEdit:d,onDelete:y}),e.jsx(w,{title:"Modifier detail du reparation",isOpen:t,onClose:()=>r(!1),size:"md",children:e.jsx(L,{onUpdateSuccess:f,initialReparationDetail:m})}),e.jsx(w,{title:"Ajouter un nouveau detail",isOpen:h,onClose:()=>o(!1),size:"md",children:e.jsx(L,{onAddSuccess:b,reparationId:s.id})})]}):e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500",children:"Chargement des informations..."})]})})})},ve=()=>{const{numericId:s}=q(),{data:t}=T(s);return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-col lg:flex-row w-full gap-4 items-start",children:[e.jsx("div",{className:"w-full lg:w-1/2",children:e.jsx(H,{reparation:t})}),e.jsx("div",{className:"w-full lg:w-1/2",children:e.jsx(se,{reparation:t})})]})})};export{ve as default};
